<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>Оплата WB6</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
<style>
  body{font-family:Inter,Arial,sans-serif;text-align:center;padding-top:60px}
</style>
</head>
<body>
<h2>Оплатите пакет переписываний</h2>
<form id="pay">
  <input type="email" id="email" placeholder="Ваш e-mail" required>
  <label>Тариф:
    <select id="plan">
      <option value="15" data-price="199">15 переписываний – 199 ₽</option>
      <option value="60" data-price="499">60 переписываний – 499 ₽</option>
    </select>
  </label>
  <button type="submit">Оплатить</button>
</form>
<script>
const PASS1 = "EyQbM1TFm6uOp6l6JEi2"; // пароль#1 из кабинета
const LOGIN = "wb.6"; // Merchant ID
const form = document.getElementById('pay');
form.onsubmit = e => {
  e.preventDefault();
  const plan = document.getElementById('plan');
  const price = plan.options[plan.selectedIndex].dataset.price;
  const inv = Date.now();
  const desc = plan.value + ' rewrite';
  const crcStr = `${LOGIN}:${price}:${inv}:${PASS1}:Shp_plan=${plan.value}`;
  const sig = CryptoJS.MD5(crcStr).toString().toUpperCase();
  const params = new URLSearchParams({
    MerchantLogin: LOGIN,
    OutSum: price,
    InvId: inv,
    Description: desc,
    SignatureValue: sig,
    Email: document.getElementById('email').value,
    Shp_plan: plan.value,
    SuccessURL: location.origin + '/pay.html?InvId=' + inv
  });
  const url = 'https://auth.robokassa.ru/Merchant/PaymentForm/FormMS.if?' + params.toString();
  location.href = url;
};

// автозагрузка токена после оплаты
const q = new URLSearchParams(location.search);
if (q.get('InvId')) {
  fetch('https://api.wb6.ru/paytoken?inv=' + q.get('InvId'))
    .then(r => r.json())
    .then(js => {
      if (js.token) {
        localStorage.setItem('wb6_jwt', js.token);
        location = 'index.html';
      }
    });
}
</script>
</body>
</html>
